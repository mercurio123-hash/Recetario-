<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Recetas 365</title>
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --color-A: #FF9800; --color-C: #4CAF50; --color-CE: #2196F3; --color-P: #E91E63;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 90px; }
        header { background: #333; color: white; text-align: center; padding: 10px; position: sticky; top: 0; z-index: 100; }
        
        /* Navegaci√≥n */
        .nav-tabs { display: flex; background: white; overflow-x: auto; border-bottom: 2px solid #ddd; }
        .tab { flex: 1; padding: 15px; border: none; background: none; font-weight: bold; cursor: pointer; min-width: 85px; font-size: 14px; }
        .tab[data-cat="A"] { color: var(--color-A); } .tab[data-cat="C"] { color: var(--color-C); }
        .tab[data-cat="CE"] { color: var(--color-CE); } .tab[data-cat="P"] { color: var(--color-P); }
        .tab.active { border-bottom: 4px solid currentColor; background: #f9f9f9; }

        .container { padding: 15px; }
        
        /* Buscador */
        .search-box { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 25px; box-sizing: border-box; font-size: 16px; }

        /* Tarjetas */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 8px solid #ccc; position: relative; }
        .card.cat-A { border-left-color: var(--color-A); }
        .card.cat-C { border-left-color: var(--color-C); }
        .card.cat-CE { border-left-color: var(--color-CE); }
        .card.cat-P { border-left-color: var(--color-P); }
        
        .badge { position: absolute; top: 10px; right: 10px; background: #333; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
        .btn-del { background: #ffeded; color: #d32f2f; border: none; padding: 5px 10px; border-radius: 5px; float: right; margin-top: -5px; font-size: 12px; cursor: pointer; }
        .btn-add-list { background: #f0f0f0; border: none; padding: 10px; border-radius: 8px; width: 100%; margin-top: 10px; font-weight: bold; }

        /* Formularios y Ajustes */
        .panel { display: none; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-main { background: #333; color: white; border: none; width: 100%; padding: 15px; border-radius: 8px; font-size: 16px; margin-top: 10px; }

        /* Barra Inferior */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #333; display: flex; justify-content: space-around; padding: 12px 0; z-index: 100; }
        .btn-nav { color: white; border: none; background: none; text-align: center; font-size: 12px; opacity: 0.8; }
        .btn-nav span { display: block; font-size: 20px; margin-bottom: 2px; }
    </style>
</head>
<body>

<header>
    <h2 id="view-title">Almuerzos</h2>
</header>

<nav class="nav-tabs" id="category-tabs">
    <button class="tab active" data-cat="A" onclick="cambiarVista('A')">Alm.</button>
    <button class="tab" data-cat="C" onclick="cambiarVista('C')">Com.</button>
    <button class="tab" data-cat="CE" onclick="cambiarVista('CE')">Cenas</button>
    <button class="tab" data-cat="P" onclick="cambiarVista('P')">Otros</button>
</nav>

<div class="container">
    <input type="text" id="buscador" class="search-box" placeholder="üîç Buscar por nombre o ingrediente..." oninput="renderRecetas()">

    <div id="app"></div>

    <div id="form-area" class="panel">
        <h3>‚ûï Nueva Receta</h3>
        <select id="f-cat">
            <option value="A">Almuerzo</option>
            <option value="C" selected>Comida</option>
            <option value="CE">Cena</option>
            <option value="P">Postres y Otros</option>
        </select>
        <input type="text" id="f-titulo" placeholder="T√≠tulo (ej: Pollo al lim√≥n)">
        <textarea id="f-ing" rows="4" placeholder="Ingredientes (uno por l√≠nea: Pollo, Ajo, etc)"></textarea>
        <textarea id="f-prep" rows="4" placeholder="Pasos de preparaci√≥n"></textarea>
        <input type="number" id="f-cal" placeholder="Calor√≠as aprox.">
        <button class="btn-main" onclick="guardarReceta()">Guardar Receta</button>
    </div>

    <div id="lista-area" class="panel">
        <h3>üõí Lista de Compras</h3>
        <div id="lista-items"></div>
        <button class="btn-main" style="background:#d32f2f" onclick="borrarLista()">Vaciar Lista</button>
    </div>

    <div id="ajustes-area" class="panel">
        <h3>‚öôÔ∏è Copia de Seguridad</h3>
        <button class="btn-main" style="background:#2196F3" onclick="exportarRecetas()">üì• Descargar todas las recetas</button>
        <hr>
        <p>Restaurar desde archivo:</p>
        <input type="file" id="importFile" accept=".json">
        <button class="btn-main" style="background:#4CAF50" onclick="importarRecetas()">üì§ Cargar Archivo</button>
    </div>
</div>

<nav class="bottom-nav">
    <button class="btn-nav" onclick="cambiarVista(currentCat)"><span>üè†</span>Inicio</button>
    <button class="btn-nav" onclick="mostrarPanel('form-area', 'Nueva Receta')"><span>‚ûï</span>A√±adir</button>
    <button class="btn-nav" onclick="mostrarPanel('lista-area', 'Compras')"><span>üõí</span>Lista</button>
    <button class="btn-nav" onclick="mostrarPanel('ajustes-area', 'Ajustes')"><span>‚öôÔ∏è</span>Backup</button>
</nav>

<script>
    let currentCat = 'A';
    let recetas = JSON.parse(localStorage.getItem('recetas_365_v2')) || [];
    let listaCompras = JSON.parse(localStorage.getItem('lista_365_v2')) || [];

    function cambiarVista(cat) {
        currentCat = cat;
        document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
        document.getElementById('app').style.display = 'block';
        document.getElementById('buscador').style.display = 'block';
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.tab[data-cat="${cat}"]`).classList.add('active');
        
        const titulos = { 'A': 'Almuerzos', 'C': 'Comidas', 'CE': 'Cenas', 'P': 'Postres y Otros' };
        document.getElementById('view-title').innerText = titulos[cat];
        renderRecetas();
    }

    function mostrarPanel(id, titulo) {
        document.getElementById('app').style.display = 'none';
        document.getElementById('buscador').style.display = 'none';
        document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.getElementById('view-title').innerText = titulo;
    }

    function renderRecetas() {
        const app = document.getElementById('app');
        const query = document.getElementById('buscador').value.toLowerCase();
        app.innerHTML = '';

        // Filtramos por categor√≠a Y por el buscador (t√≠tulo o ingredientes)
        const filtradas = recetas.filter(r => {
            const matchesCat = r.categoria === currentCat;
            const matchesSearch = r.titulo.toLowerCase().includes(query) || r.ingredientes.toLowerCase().includes(query);
            return matchesCat && matchesSearch;
        });

        if(filtradas.length === 0) app.innerHTML = '<p style="text-align:center; color:#888;">No hay recetas que coincidan.</p>';

        filtradas.forEach(r => {
            const card = document.createElement('div');
            card.className = `card cat-${r.categoria}`;
            card.innerHTML = `
                <button class="btn-del" onclick="borrarReceta('${r.id}')">Eliminar üóëÔ∏è</button>
                <span class="badge">${r.id}</span>
                <h3 style="margin:0 0 10px 0">${r.titulo}</h3>
                <p style="font-size:14px"><strong>Ingredientes:</strong><br>${r.ingredientes.replace(/\n/g, '<br>')}</p>
                <p style="font-size:14px; background:#fdfdfd; padding:5px; border-radius:5px;"><strong>Preparaci√≥n:</strong><br>${r.preparacion}</p>
                <div style="font-size:11px; color:#777; margin-top:10px;">üìÖ ${r.fecha} | üî• ${r.calorias} kcal</div>
                <button class="btn-add-list" onclick="agregarALista('${r.id}')">üõí A√±adir a Compras</button>
            `;
            app.appendChild(card);
        });
    }

    function guardarReceta() {
        const cat = document.getElementById('f-cat').value;
        const num = recetas.filter(r => r.categoria === cat).length + 1;
        const nueva = {
            id: `${cat}-${num}`,
            categoria: cat,
            titulo: document.getElementById('f-titulo').value || 'Sin t√≠tulo',
            ingredientes: document.getElementById('f-ing').value || '',
            preparacion: document.getElementById('f-prep').value || '',
            calorias: document.getElementById('f-cal').value || 0,
            fecha: new Date().toLocaleDateString()
        };
        recetas.push(nueva);
        actualizarLocal();
        document.getElementById('f-titulo').value = '';
        document.getElementById('f-ing').value = '';
        document.getElementById('f-prep').value = '';
        cambiarVista(cat);
    }

    function borrarReceta(id) {
        if(confirm(`¬øBorrar la receta ${id}?`)) {
            recetas = recetas.filter(r => r.id !== id);
            actualizarLocal();
            renderRecetas();
        }
    }

    function agregarALista(id) {
        const r = recetas.find(rec => rec.id === id);
        listaCompras.push({ titulo: r.titulo, ing: r.ingredientes });
        localStorage.setItem('lista_365_v2', JSON.stringify(listaCompras));
        alert("A√±adido a la lista");
    }

    function borrarLista() {
        if(confirm("¬øVaciar lista?")) {
            listaCompras = [];
            localStorage.setItem('lista_365_v2', JSON.stringify(listaCompras));
            mostrarPanel('lista-area', 'Compras');
        }
    }

    function actualizarLocal() {
        localStorage.setItem('recetas_365_v2', JSON.stringify(recetas));
    }

    function exportarRecetas() {
        const blob = new Blob([JSON.stringify(recetas, null, 2)], {type : 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `backup_recetas_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function importarRecetas() {
        const file = document.getElementById('importFile').files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            recetas = JSON.parse(e.target.result);
            actualizarLocal();
            alert("Restaurado!");
            cambiarVista('A');
        };
        reader.readAsText(file);
    }

    cambiarVista('A');
</script>
</body>
</html>